{% extends "base.html" %}

{% block title %}Review - {{ language.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Review - {{ language.name }}</h3>
                </div>
                <div class="card-body">
                    <div id="review-area">
                        <!-- Flashcard -->
                        <div class="flashcard mb-4">
                            <div class="card">
                                <div class="card-body text-center position-relative">
                                    <!-- Level indicator -->
                                    <div class="position-absolute top-0 end-0 p-2">
                                        <small class="text-muted">Level <span id="card-level"></span></small>
                                    </div>
                                    <div id="front" class="mb-3">
                                        <h4 id="term"></h4>
                                        <p id="context" class="text-muted"></p>
                                    </div>
                                    <div id="back" class="d-none">
                                        <h4 id="translation"></h4>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="text-center">
                            <button id="show-answer" class="btn btn-primary mb-3">Show Answer</button>
                            
                            <div id="rating-buttons" class="d-none">
                                <button class="btn btn-danger me-2 text-dark" data-rating="again">Again</button>
                                <button class="btn me-2 text-dark" style="background-color: #ffc107; border-color: #ffc107;" data-rating="hard">Hard</button>
                                <button class="btn me-2 text-dark" style="background-color: #17a2b8; border-color: #17a2b8;" data-rating="good">Good (+1)</button>
                                <button class="btn text-dark" style="background-color: #28a745; border-color: #28a745;" data-rating="easy">Known</button>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="progress mt-4">
                            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2">
                            <span id="progress-text">0/0</span>
                        </div>
                    </div>

                    <!-- Session Complete Message -->
                    <div id="session-complete" class="text-center d-none">
                        <h4>Review Session Complete!</h4>
                        <p>You've reviewed all available cards.</p>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Return to Dashboard</a>
                    </div>

                    <!-- No Cards Message -->
                    <div id="no-cards" class="text-center d-none">
                        <h4>No Cards to Review</h4>
                        <p>There are no cards available for review at this time.</p>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Return to Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let reviewCards = [];
let currentCardIndex = 0;

// Load review cards when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadReviewCards();
});

function loadReviewCards() {
    fetch(`/api/review/{{ language.id }}`)
        .then(response => response.json())
        .then(data => {
            if (data.review_cards && data.review_cards.length > 0) {
                reviewCards = data.review_cards;
                showCurrentCard();
                updateProgress();
            } else {
                showNoCards();
            }
        })
        .catch(error => {
            console.error('Error loading review cards:', error);
            showNoCards();
        });
}

function showCurrentCard() {
    if (currentCardIndex >= reviewCards.length) {
        showSessionComplete();
        return;
    }

    const card = reviewCards[currentCardIndex];
    
    // Set the front and back content based on direction
    if (card.direction === 'ru_to_en') {
        document.getElementById('term').textContent = card.term;
        document.getElementById('translation').textContent = card.translation;
    } else {
        document.getElementById('term').textContent = card.translation;
        document.getElementById('translation').textContent = card.term;
    }
    
    document.getElementById('context').textContent = card.context_sentence || '';
    document.getElementById('card-level').textContent = card.status;
    
    // Reset card state
    document.getElementById('back').classList.add('d-none');
    document.getElementById('show-answer').classList.remove('d-none');
    document.getElementById('rating-buttons').classList.add('d-none');
}

function showAnswer() {
    document.getElementById('back').classList.remove('d-none');
    document.getElementById('show-answer').classList.add('d-none');
    document.getElementById('rating-buttons').classList.remove('d-none');
}

function rateCard(rating) {
    const card = reviewCards[currentCardIndex];
    
    fetch('/api/review/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            term_id: card.id,
            rating: rating,
            direction: card.direction
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Move to next card
            currentCardIndex++;
            updateProgress();
            showCurrentCard();
        } else {
            console.error('Error updating card:', data.error);
        }
    })
    .catch(error => {
        console.error('Error rating card:', error);
    });
}

function updateProgress() {
    const progress = (currentCardIndex / reviewCards.length) * 100;
    document.getElementById('progress-bar').style.width = `${progress}%`;
    document.getElementById('progress-text').textContent = `${currentCardIndex}/${reviewCards.length}`;
}

function showSessionComplete() {
    document.getElementById('review-area').classList.add('d-none');
    document.getElementById('session-complete').classList.remove('d-none');
}

function showNoCards() {
    document.getElementById('review-area').classList.add('d-none');
    document.getElementById('no-cards').classList.remove('d-none');
}

// Event Listeners
document.getElementById('show-answer').addEventListener('click', showAnswer);

document.querySelectorAll('[data-rating]').forEach(button => {
    button.addEventListener('click', function() {
        rateCard(this.dataset.rating);
    });
});
</script>
{% endblock %} 