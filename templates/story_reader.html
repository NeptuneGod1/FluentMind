{% extends "base.html" %}

{% block title %}{{ story.title }} - {{ language.name }} Reader - FluentMind{% endblock %}

{% block content %}
<div class="reader-content">
    <div class="reader-header">
        <h1>{{ story.title }}</h1>
        <p>Language: {{ language.name }} | Theme: {{ story.theme }}</p>
        <a href="{{ url_for('language_lessons', lang_name=language.name.lower()) }}" class="btn btn-secondary btn-sm">&laquo; Back to {{ language.name }}</a>
    </div>

    <!-- Media Player Section -->
    <div class="media-player-container" style="margin-bottom: 20px;">
        <!-- Repeat Controls -->
        <div class="d-flex align-items-center justify-content-center flex-wrap mb-2" style="gap: 4px;">
            <!-- Repeat Range Button -->
        <button id="repeat-range-btn" class="btn btn-sm btn-outline-secondary me-1" title="Repeat Page Range">
            <i class="bi bi-arrow-left-right"></i>
        </button>
        
            <!-- Repeat Page Button -->
            <button id="repeat-page-btn" class="btn btn-sm btn-outline-secondary me-1" title="Repeat Current Page">
                <i class="bi-arrow-repeat"></i> Page
            </button>
            
            <!-- Navigation Buttons -->
            <button id="prev-page-btn" class="btn btn-sm btn-outline-secondary me-1">&laquo; Prev</button>
            
            <!-- Page Indicator -->
            <span class="mx-2">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
            
            <button id="next-page-btn" class="btn btn-sm btn-outline-secondary me-1">Next &raquo;</button>
            
            <!-- Repeat Sentence Button -->
            
            <button id="repeat-sentence-btn" class="btn btn-sm btn-outline-secondary me-1" title="Repeat Current Sentence">
                <i class="bi-arrow-repeat"></i> Sentence
            </button>
            
            <!-- Adjust Button -->
            <button id="adjust-timestamps-btn" title="Adjust Timestamps" class="btn btn-sm btn-outline-secondary">⏱️ Adjust</button>
            <button id="autoscroll-toggle-btn" title="Toggle Autoscroll" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrows-vertical"></i></button>
        </div>
        

<!-- Orphaned modal content fully removed -->
<!-- End of media-player controls -->
        </div>

<!-- Page Range Modal -->
<div class="modal fade" id="pageRangeModal" tabindex="-1" aria-labelledby="pageRangeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pageRangeModalLabel">Set Page Range to Repeat</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="startPageInput" class="form-label">Start Page:</label>
          <input type="number" class="form-control" id="startPageInput" min="1">
        </div>
        <div class="mb-3">
          <label for="endPageInput" class="form-label">End Page:</label>
          <input type="number" class="form-control" id="endPageInput" min="1">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="applyRangeBtn">Apply</button>
      </div>
    </div>
  </div>
</div>

{% if story.media_url %}
            {% if '.mp4' in story.media_url or '.avi' in story.media_url or '.mov' in story.media_url or '.mkv' in story.media_url or '.webm' in story.media_url %}
                <video controls width="100%" src="{{ story.media_url }}">
                    Your browser does not support the video tag.
                </video>
            {% elif '.mp3' in story.media_url or '.wav' in story.media_url or '.ogg' in story.media_url %}
                <audio controls src="{{ story.media_url }}">
                    Your browser does not support the audio element.
                </audio>
            {% else %}
                <p>Unsupported media type for uploaded file.</p>
            {% endif %}
        {% elif story.youtube_url %}
            {% set youtube_embed_url = story.youtube_url.replace('watch?v=', 'embed/') %}
            <iframe width="100%" height="315" src="{{ youtube_embed_url }}" 
                    frameborder="0" allow="accelerometer; autoplay; clipboard-write; 
                    encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
            </iframe>
        {% else %}
            <p>No media provided for this lesson.</p>
        {% endif %}
    </div>

    <div class="grammar-notes-control" style="margin-bottom: 15px; padding: 10px 0; border-bottom: 1px solid #eee;">
        <div class="d-flex align-items-center">
            <select id="llm-selector" class="form-select form-select-sm me-2" style="flex: 1;">
                <option value="chatgpt">ChatGPT</option>
                <option value="gemini">Gemini</option>
            </select>
            <a href="#" id="view-grammar-notes" 
               data-item-type="story" 
               data-item-id="{{ story.id }}"
               class="btn btn-outline-primary btn-sm">
                View Grammar Notes
            </a>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const viewGrammarBtn = document.getElementById('view-grammar-notes');
        const llmSelector = document.getElementById('llm-selector');
        
        viewGrammarBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const itemType = this.dataset.itemType;
            const itemId = this.dataset.itemId;
            const llm = llmSelector.value;
            
            // Open the grammar notes in a new tab with the selected LLM
            window.open(`/view_grammar/${itemType}/${itemId}?llm=${llm}`, '_blank');
        });
    });
    </script>

    <div class="reader-main" data-item-type="story" data-item-id="{{ story.id }}">
        <div id="lesson-text" class="lesson-text-container">
            <p>Loading story...</p>
        </div>

        <input type="hidden" id="language_id" value="{{ language.id }}">
        <div id="raw-story-content" style="display: none;">{{ story.content }}</div>

        <div id="vocab-interaction-panel" class="vocab-interaction-panel" style="display: none;">
            <h4 id="selected-term"></h4>
            <p>Status: <span id="current-status-text"></span></p>
            <div class="status-buttons">
                {% for i in range(1, 6) %}
                    <button class="btn btn-sm status-btn" data-status="{{ i }}">{{ i }}</button>
                {% endfor %}
                <button class="btn btn-sm status-btn btn-success" data-status="6">Known</button>
                <button class="btn btn-sm status-btn btn-secondary" data-status="7">Ignore</button>
            </div>
            <div class="translation-area">
                <textarea id="translation-input" placeholder="Enter translation..."></textarea>
                <button id="save-translation-btn" class="btn btn-primary btn-sm">Save</button>
            </div>
            <button id="lookup-dict-btn" class="btn btn-info btn-sm">Look Up</button>
            <div id="multiword-options" style="display: none;">
                 <button id="select-multiword-btn" class="btn btn-warning btn-sm">Select Multi-Word</button>
                 <button id="cancel-multiword-btn" class="btn btn-light btn-sm">Cancel</button>
                 <p id="current-multiword-selection"></p>
            </div>
            <p id="interaction-message" class="inline-message"></p>
        </div>

         <div id="dictionary-panel" class="dictionary-panel" style="display: none;">
            <h4>Dictionary Lookup</h4>
            <div id="dictionary-links">Loading dictionaries...</div>
            <iframe id="dictionary-frame" width="100%" height="400px" style="border: 1px solid #ccc; margin-top: 10px;"></iframe>
            <button id="close-dict-panel-btn" class="btn btn-secondary btn-sm">Close</button>
        </div>
    </div>

    <div class="repeat-range-controls">
        <label for="repeat-range">Repeat Range:</label>
        <select id="repeat-range" class="form-select form-select-sm">
            <option value="all">All</option>
            <option value="1-5">1-5</option>
            <option value="6-10">6-10</option>
            <option value="11-15">11-15</option>
        </select>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script>
document.addEventListener('DOMContentLoaded', function() {
    const languageId = document.getElementById('language_id').value;
    const textContainer = document.getElementById('lesson-text');
    const rawContentElement = document.getElementById('raw-story-content');
    
    if (!languageId || !textContainer || !rawContentElement) {
        console.error("Essential elements (language_id, lesson-text, raw-story-content) not found!");
        textContainer.innerHTML = '<p class="text-danger">Error loading story content.</p>';
        return;
    }
    
    const rawText = rawContentElement.textContent;

    if (typeof parseText === 'function' && typeof fetchVocabStatus === 'function' && typeof fetchMultiwordTerms === 'function') {
        console.log("Initializing story reader...");
        const parsedElements = parseText(rawText);
        const uniqueSingleTerms = [...new Set(parsedElements.filter(p => p.type === 'word').map(p => p.term.toLowerCase()))];

        Promise.all([
            fetchVocabStatus(languageId, uniqueSingleTerms),
            fetchMultiwordTerms(languageId)
        ])
        .then(([singleWordVocab, multiwordTerms]) => {
            vocabCache = singleWordVocab;
            multiwordTermsCache = multiwordTerms;
            
            const styledHtml = buildStyledHtml(parsedElements, vocabCache, multiwordTermsCache);
            textContainer.innerHTML = styledHtml;
            addWordClickListeners();
            console.log("Story reader initialized.");
            
            // Initialize page range functionality
            initializePageRange();
        })
        .catch(error => {
            console.error("Error initializing story reader:", error);
            textContainer.innerHTML = '<p class="text-danger">Error loading story data.</p>';
        });

    } else {
        console.error("Core reader functions (parseText, etc.) not found. Ensure script.js is loaded correctly.");
        textContainer.innerHTML = '<p class="text-danger">Error initializing reader script components.</p>';
    }

    // Update page indicator when page changes
    document.addEventListener('pageChanged', function() {
        const currentPageEl = document.getElementById('current-page');
        const totalPagesEl = document.getElementById('total-pages');
        
        if (currentPageEl) currentPageEl.textContent = currentPage;
        if (totalPagesEl && pageInfo) totalPagesEl.textContent = pageInfo.length;
    });
});
</script>

{% block scripts %}
<script src="{{ url_for('static', filename='js/page-range.js') }}"></script>
{% endblock %} 